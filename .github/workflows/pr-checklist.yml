name: PR Checklist
on:
  pull_request:

  issue_comment:
    types: [edited]

jobs:
  create-comment:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
            <!-- PR CHECKLIST -->
            - [ ] Does your PR title include the JIRA ticket number?
            - [ ] Did you write all the tests that need to be written for this change?
            - [ ] Is everything that should be wrapped in a feature flag properly gated?
            - [ ] Did you file any followup tickets that need to be filed?
              `
            })
  check-comment:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.issue.state == 'open' && contains(github.event.comment.body, '<!-- PR CHECKLIST -->')
    runs-on: ubuntu-latest
    steps:
      - name: Get Branch
        id: get-branch
        run: echo ::set-output name=head_sha::$(gh pr view $PR_NO --repo $REPO --json .headRefOid --jq '..headRefOid')
        env:
          REPO: ${{ github.repository }}
          PR_NO: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ github.token }}
      # - name: Checkout
      #   uses: actions/checkout@v4
      #   with:
      #     ref: ${{ steps.get-branch.outputs.branch }}
      - uses: actions/github-script@v7
        with:
          script: |
            console.log(JSON.stringify(context.payload, null, 2))
            const unfinishedChecklist = context.payload.comment.body.match(/- \[ \] (.+)/g)
              .filter(checklistItem => !checklistItem.includes('[x]'));

            if (unfinishedChecklist.length > 0) {
              core.setFailed(`Unfinished checklist items found:\n${unfinishedChecklist.join('\n')}`);
            }
      - name: Set latest commit status as ${{ job.status }}
        uses: myrotvorets/set-commit-status-action@master
        if: always()
        with:
          sha: ${{ steps.get-branch.outputs.head_sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
